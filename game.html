<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Jogo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="waiting-lobby-screen" class="screen active">
        <h2>Lobby da Sala</h2>
        <p>Código: <span id="lobby-room-code"></span></p>
        <p>Jogadores:</p>
        <ul id="players-list"></ul>
        <button id="start-game-button" style="display: none;">Começar Jogo</button>
        <p id="wait-message" style="display: block;">Aguardando o host iniciar o jogo...</p>
    </div>
    <div id="category-screen" class="screen">
        <h2>Escolha uma categoria:</h2>
        <div class="category-buttons">
            <button class="category-button" data-category="tecnologia">Tecnologia</button>
            <button class="category-button" data-category="filmes">Filmes</button>
            <button class="category-button" data-category="esportes">Esportes</button>
        </div>
    </div>
    <div id="quiz-screen" class="screen">
        <div id="question-container">
            <h3 id="question-text"></h3>
            <div id="answer-buttons"></div>
        </div>
        <div id="quiz-footer">
            <span id="player-score">Pontuação: 0</span>
        </div>
    </div>
    <div id="result-screen" class="screen">
        <h2>Fim de jogo!</h2>
        <div id="leaderboard-container">
            <h3>Placar da Sala</h3>
            <ul id="leaderboard-list"></ul>
        </div>
        <button id="restart-button" style="display: none;">Jogar Novamente</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // --- CONFIGURAÇÃO E VERIFICAÇÃO INICIAL ---
        const playerNickname = localStorage.getItem('playerNickname');
        const currentRoomId = localStorage.getItem('currentRoomId');
        if (!playerNickname || !currentRoomId) {
            alert("Erro: Dados da sessão não encontrados. Retornando ao lobby.");
            window.location.href = 'lobby.html';
        }
        document.getElementById('lobby-room-code').textContent = currentRoomId;

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAnTMGJcf0lsFMqB9A6R__PJ4g_D0xjS_4",
            authDomain: "star-quiz-9c417.firebaseapp.com",
            databaseURL: "https://star-quiz-9c417-default-rtdb.firebaseio.com",
            projectId: "star-quiz-9c417",
            storageBucket: "star-quiz-9c417.firebasestorage.app",
            messagingSenderId: "377871658085",
            appId: "1:377871658085:web:769cfd88ecc841d11b2a8c",
            measurementId: "G-6RPJ0R2L9Z"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- VARIÁVEIS E DADOS DO JOGO ---
        const allScreens = {
            waiting: document.getElementById('waiting-lobby-screen'),
            category: document.getElementById('category-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };
        const playersList = document.getElementById('players-list');
        const startGameButton = document.getElementById('start-game-button');
        const waitMessage = document.getElementById('wait-message');
        const questionText = document.getElementById('question-text');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const playerScoreDisplay = document.getElementById('player-score');
        const restartButton = document.getElementById('restart-button');
        const categoryButtons = document.querySelectorAll('.category-button');
        const leaderboardList = document.getElementById('leaderboard-list');

        let roomQuestions = [];
        let localIsHost = false;
        let gameInProgress = false;

        const questions = { tecnologia: [ { question: "Qual empresa criou o sistema operacional Android?", answers: [ { text: "Apple", correct: false }, { text: "Microsoft", correct: false }, { text: "Google", correct: true }, { text: "Samsung", correct: false }, ] }, { question: "Qual linguagem de programação é a base para a web?", answers: [ { text: "Python", correct: false }, { text: "Java", correct: false }, { text: "JavaScript", correct: true }, { text: "C++", correct: false }, ] } ], filmes: [ { question: "Qual filme tem a famosa frase 'Luke, eu sou seu pai'?", answers: [ { text: "Star Wars: O Império Contra-Ataca", correct: true }, { text: "Star Wars: Uma Nova Esperança", correct: false }, { text: "Vingadores: Ultimato", correct: false }, { text: "Matrix", correct: false }, ] }, { question: "Quem dirigiu o filme 'Pulp Fiction'?", answers: [ { text: "Martin Scorsese", correct: false }, { text: "Steven Spielberg", correct: false }, { text: "Quentin Tarantino", correct: true }, { text: "Christopher Nolan", correct: false }, ] } ], esportes: [ { question: "Em qual esporte a expressão 'strike' é usada?", answers: [ { text: "Basquete", correct: false }, { text: "Beisebol", correct: true }, { text: "Futebol", correct: false }, { text: "Tênis", correct: false }, ] }, { question: "Quantos jogadores um time de vôlei de quadra tem em jogo?", answers: [ { text: "4", correct: false }, { text: "5", correct: false }, { text: "6", correct: true }, { text: "7", correct: false }, ] } ] };

        // --- FUNÇÕES DO JOGO ---
        function resetRoom(roomId) {
            const roomRef = database.ref(`rooms/${roomId}`);
            return roomRef.transaction(roomData => {
                if (roomData) {
                    if (roomData.players) {
                        Object.keys(roomData.players).forEach(nickname => {
                            roomData.players[nickname].score = 0;
                            delete roomData.players[nickname].questionsAnswered;
                        });
                    }
                    roomData.status = 'waiting';
                    delete roomData.questions;
                }
                return roomData;
            });
        }

        function showScreen(screenToShow) {
            Object.values(allScreens).forEach(s => s.classList.remove('active'));
            screenToShow.classList.add('active');
        }

        startGameButton.addEventListener('click', () => {
            database.ref('rooms/' + currentRoomId).update({ status: 'selecting_category' });
        });
        
        categoryButtons.forEach(button => {
            button.addEventListener('click', () => {
                const selectedCategory = button.dataset.category;
                const questionsToSend = questions[selectedCategory];
                
                const roomRef = database.ref('rooms/' + currentRoomId);
                roomRef.once('value', (snapshot) => {
                    const roomData = snapshot.val();
                    if (roomData && roomData.players) {
                        Object.keys(roomData.players).forEach(nickname => {
                           roomData.players[nickname].questionsAnswered = 0;
                        });
                        roomRef.update({
                            status: 'playing',
                            questions: questionsToSend,
                            players: roomData.players
                        });
                    }
                });
            });
        });

        function showQuestion(questionIndex) {
            const currentQuestion = roomQuestions[questionIndex];
            if (currentQuestion) {
                questionText.textContent = currentQuestion.question;
                answerButtonsContainer.innerHTML = '';
                currentQuestion.answers.forEach(answer => {
                    const button = document.createElement('button');
                    button.textContent = answer.text;
                    button.classList.add('answer-button');
                    if (answer.correct) button.dataset.correct = true;
                    button.addEventListener('click', selectAnswer);
                    answerButtonsContainer.appendChild(button);
                });
            }
        }
        
        // CORREÇÃO: Nova função para o anfitrião (host) verificar se o jogo terminou
        function checkIfGameIsOver() {
            if (!localIsHost) return; // Apenas o anfitrião executa esta verificação

            const roomRef = database.ref('rooms/' + currentRoomId);
            // Usamos .once() para ler os dados uma vez e evitar loops
            roomRef.once('value', (snapshot) => {
                const roomData = snapshot.val();
                if (roomData && roomData.status === 'playing' && roomData.questions) {
                    const totalQuestions = roomData.questions.length;
                    let allPlayersFinished = true;
                    Object.values(roomData.players).forEach(player => {
                        if ((player.questionsAnswered || 0) < totalQuestions) {
                            allPlayersFinished = false;
                        }
                    });

                    if (allPlayersFinished) {
                        // Se todos terminaram, o anfitrião (host) muda o estado da sala
                        roomRef.update({ status: 'finished' });
                    }
                }
            });
        }
        
        function selectAnswer(e) {
            Array.from(answerButtonsContainer.children).forEach(button => button.disabled = true);
            
            const isCorrect = e.target.dataset.correct === 'true';
            if (isCorrect) {
                const scoreRef = database.ref(`rooms/${currentRoomId}/players/${playerNickname}/score`);
                scoreRef.transaction(currentScore => (currentScore || 0) + 1);
            }

            const answeredRef = database.ref(`rooms/${currentRoomId}/players/${playerNickname}/questionsAnswered`);
            // CORREÇÃO: Usamos o callback da transação para acionar a verificação do fim do jogo
            answeredRef.transaction(currentCount => (currentCount || 0) + 1, (error, committed) => {
                if (committed) {
                    // Após a resposta ser registada com sucesso, verificamos se o jogo terminou
                    checkIfGameIsOver();
                }
            });
        }

        restartButton.addEventListener('click', () => {
            resetRoom(currentRoomId);
        });

        function handleHostUI(players) {
            localIsHost = players && players[playerNickname] && players[playerNickname].isHost;
            if (localIsHost) {
                startGameButton.style.display = 'block';
                restartButton.style.display = 'block';
                waitMessage.style.display = 'none';
            } else {
                startGameButton.style.display = 'none';
                restartButton.style.display = 'none';
                waitMessage.style.display = 'block';
            }
        }

        function syncLeaderboard() {
            const playersRef = database.ref(`rooms/${currentRoomId}/players`);
            playersRef.once('value', snapshot => {
                const players = snapshot.val();
                leaderboardList.innerHTML = '';
                if (players) {
                    const playersArray = Object.values(players).sort((a, b) => b.score - a.score);
                    playersArray.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = `${player.nickname}: ${player.score} pontos`;
                        leaderboardList.appendChild(li);
                    });
                }
            });
        }
        
        function syncPlayersList() {
            const roomRef = database.ref('rooms/' + currentRoomId);
            roomRef.on('value', snapshot => {
                const roomData = snapshot.val();
                if (!roomData) {
                    if (gameInProgress) {
                        alert("A sala foi fechada. Retornando ao lobby.");
                        window.location.href = 'lobby.html';
                    }
                    return;
                }
                
                const players = roomData.players;
                playersList.innerHTML = '';
                if (players) {
                    Object.keys(players).forEach(nickname => {
                        const li = document.createElement('li');
                        li.textContent = nickname;
                        playersList.appendChild(li);
                    });
                    handleHostUI(players);
                }

                // REMOVIDO: A verificação de fim de jogo foi movida para um local mais apropriado

                switch (roomData.status) {
                    case 'waiting':
                        gameInProgress = false; 
                        showScreen(allScreens.waiting);
                        break;
                    case 'selecting_category':
                        if (localIsHost) showScreen(allScreens.category);
                        else showScreen(allScreens.waiting);
                        break;
                    case 'playing':
                        if (!gameInProgress) { 
                            gameInProgress = true; 
                            roomQuestions = roomData.questions;
                        }
                        const myPlayerData = players ? players[playerNickname] : null;
                        if(myPlayerData) {
                            const myQuestionIndex = myPlayerData.questionsAnswered || 0;
                            playerScoreDisplay.textContent = `Pontuação: ${myPlayerData.score || 0}`;

                            if (myQuestionIndex < roomQuestions.length) {
                                showScreen(allScreens.quiz);
                                showQuestion(myQuestionIndex);
                            } else {
                                showScreen(allScreens.quiz);
                                questionText.textContent = "Aguardando os outros jogadores...";
                                answerButtonsContainer.innerHTML = '';
                            }
                        }
                        break;
                    case 'finished':
                        gameInProgress = false; 
                        showScreen(allScreens.result);
                        syncLeaderboard();
                        break;
                }
            });
        }

        // --- INICIALIZAÇÃO DO JOGO ---
        syncPlayersList();
    </script>
</body>
</html>